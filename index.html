<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>CSV 交易周报分析器</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        h1 {
            color: #1a1a1a;
        }
        #container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        input[type="file"] {
            margin-bottom: 10px;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #status {
            margin-top: 15px;
            font-size: 1.1em;
            color: #555;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            color: #333;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        td:nth-child(2), td:nth-child(3) {
            text-align: right;
            font-family: "Courier New", Courier, monospace;
        }
    </style>
</head>
<body>

    <div id="container">
        <h1>CSV 交易周报分析器</h1>
        <p>请上传您的 `20251023_Main_trades.csv` 或格式相同的文件。</p>
        
        <input type="file" id="csvFileInput" accept=".csv">
        
        <button onclick="handleFile()">开始分析</button>
        
        <div id="status">请选择文件并点击“开始分析”。</div>
        
        <div id="resultsTable"></div>
    </div>

    <script>
        /**
         * 启动文件处理
         */
        function handleFile() {
            const fileInput = document.getElementById('csvFileInput');
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('resultsTable');

            if (fileInput.files.length === 0) {
                statusDiv.textContent = "错误：请先选择一个文件。";
                statusDiv.style.color = 'red';
                return;
            }

            const file = fileInput.files[0];
            statusDiv.textContent = `正在处理文件: ${file.name}...`;
            statusDiv.style.color = 'blue';
            resultsDiv.innerHTML = ""; // 清空旧结果

            const reader = new FileReader();

            // 文件读取完成后的回调
            reader.onload = function(event) {
                try {
                    const csvData = event.target.result;
                    const results = processCSV(csvData);
                    displayResults(results);
                    statusDiv.textContent = "分析完成！";
                    statusDiv.style.color = 'green';
                } catch (error) {
                    statusDiv.textContent = `处理失败: ${error.message}`;
                    statusDiv.style.color = 'red';
                    console.error(error);
                }
            };

            // 文件读取失败的回调
            reader.onerror = function() {
                statusDiv.textContent = "错误：无法读取文件。";
                statusDiv.style.color = 'red';
            };

            // 以文本形式读取文件
            reader.readAsText(file);
        }

        /**
         * 核心处理逻辑，解析CSV并统计
         * @param {string} csvData - CSV文件的文本内容
         */
        function processCSV(csvData) {
            const lines = csvData.split(/\r?\n/); // 按行分割
            
            if (lines.length < 2) {
                throw new Error("文件为空或没有数据行。");
            }

            // 1. 解析表头
            const header = lines[0].split(',');
            const colIndices = {
                timestamp: header.indexOf('timestamp'),
                fee: header.indexOf('fee'),
                price: header.indexOf('price'),
                quantity: header.indexOf('quantity')
            };

            // 检查必需的列
            for (const col of ['timestamp', 'fee', 'price', 'quantity']) {
                if (colIndices[col] === -1) {
                    throw new Error(`CSV文件中缺少必需的列: '${col}'`);
                }
            }

            // 2. 定义周期
            // 使用 Date.UTC 确保时区一致性 (0 = 1月, 8 = 9月)
            const startDate = new Date(Date.UTC(2025, 8, 12)); // 2025-09-11
            const msPerDay = 1000 * 60 * 60 * 24;

            // 3. 遍历数据行
            const weeklyStats = new Map();

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue; // 跳过空行

                const row = line.split(',');
                
                // 确保行数据完整
                if (row.length < header.length) continue;

                // 4. 按要求处理日期
                const timestampStr = row[colIndices.timestamp];
                if (!timestampStr || timestampStr.length < 10) continue; // 跳过无效时间戳

                const dateStr = timestampStr.substring(0, 10); // 截取 'YYYY-MM-DD'
                
                // 将 'YYYY-MM-DD' 字符串转为 UTC 日期对象
                const parts = dateStr.split('-');
                if (parts.length < 3) continue;
                
                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // JS 月份从0开始
                const day = parseInt(parts[2], 10);
                
                const dateOnly = new Date(Date.UTC(year, month, day));

                // 5. 过滤并计算周期
                if (dateOnly < startDate) {
                    continue; // 忽略早于起始日期的数据
                }

                const timeDiff = dateOnly.getTime() - startDate.getTime();
                const daysDiff = Math.floor(timeDiff / msPerDay);
                const weekNumber = Math.floor(daysDiff / 7) + 1;

                // 6. 创建周期标签
                const weekStartDate = new Date(startDate.getTime());
                weekStartDate.setUTCDate(weekStartDate.getUTCDate() + (weekNumber - 1) * 7);

                const weekEndDate = new Date(weekStartDate.getTime());
                weekEndDate.setUTCDate(weekEndDate.getUTCDate() + 6);
                
                const periodStr = `第 ${weekNumber} 周 ${formatDate(weekStartDate)} - ${formatDate(weekEndDate, true)}`;

                // 7. 解析数值并计算
                const fee = parseFloat(row[colIndices.fee]);
                const price = parseFloat(row[colIndices.price]);
                const quantity = parseFloat(row[colIndices.quantity]);

                if (isNaN(fee) || isNaN(price) || isNaN(quantity)) {
                    continue; // 跳过无效数值
                }

                const tradeVolume = price * quantity;

                // 8. 累加统计
                if (!weeklyStats.has(periodStr)) {
                    weeklyStats.set(periodStr, {
                        total_fee: 0,
                        total_volume: 0,
                        week_number: weekNumber // 用于排序
                    });
                }

                const stats = weeklyStats.get(periodStr);
                stats.total_fee += fee;
                stats.total_volume += tradeVolume;
            }

            // 9. 排序
            const sortedResults = Array.from(weeklyStats.entries());
            sortedResults.sort((a, b) => a[1].week_number - b[1].week_number);

            return sortedResults;
        }

        /**
         * 将结果显示为 HTML 表格
         * @param {Array} sortedResults - 排序后的统计结果
         */
        function displayResults(sortedResults) {
            const resultsDiv = document.getElementById('resultsTable');
            if (sortedResults.length === 0) {
                resultsDiv.innerHTML = "<p>在指定日期范围内没有找到可统计的数据。</p>";
                return;
            }

            let tableHTML = '<table>';
            tableHTML += '<thead><tr><th>Week Period</th><th>Total Fee</th><th>Total Volume</th></tr></thead>';
            tableHTML += '<tbody>';

            for (const [period, stats] of sortedResults) {
                tableHTML += `
                    <tr>
                        <td>${period}</td>
                        <td>${stats.total_fee.toFixed(8)}</td>
                        <td>${stats.total_volume.toFixed(8)}</td>
                    </tr>
                `;
            }

            tableHTML += '</tbody></table>';
            resultsDiv.innerHTML = tableHTML;
        }

        /**
         * 辅助函数：格式化日期为 'September 11' 或 'September 17, 2025'
         * @param {Date} date - 日期对象
         * @param {boolean} includeYear - 是否包含年份
         */
        function formatDate(date, includeYear = false) {
            // 使用 en-US locale 来匹配 "September 11" 格式
            const options = {
                month: 'long',
                day: 'numeric',
                timeZone: 'UTC'
            };

            if (includeYear) {
                options.year = 'numeric';
            }
            
            return date.toLocaleDateString('en-US', options);
        }

    </script>

</body>
</html>
