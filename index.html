<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>CSV äº¤æ˜“å‘¨æŠ¥åˆ†æå™¨ (v3)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        h1 {
            color: #1a1a1a;
        }
        #container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .controls {
            display: flex;
            align-items: center;
            gap: 15px; /* æ§ä»¶ä¹‹é—´çš„é—´è· */
            flex-wrap: wrap; /* è‡ªåŠ¨æ¢è¡Œ */
        }
        input[type="file"] {
            margin-bottom: 0;
        }
        input[type="number"] {
            width: 60px;
            padding: 5px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        label {
            font-weight: bold;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #0056b3;
        }

        /* æ–°å¢ï¼šæ¨ç‰¹æŒ‰é’®çš„æ¬¡è¦æ ·å¼ */
        button.secondary {
            background-color: #6c757d; /* ç°è‰² */
        }
        button.secondary:hover {
            background-color: #5a6268;
        }

        #status {
            margin-top: 15px;
            font-size: 1.1em;
            color: #555;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            color: #333;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        td:nth-child(2), td:nth-child(3), td:nth-child(4) {
            text-align: right;
            font-family: "Courier New", Courier, monospace;
        }
    </style>
</head>
<body>

    <div id="container">
        <h1>backpack äº¤æ˜“å‘¨æŠ¥åˆ†æ (çº¯å‰ç«¯ï¼Œä¸ä¼šä¸Šä¼ æ•°æ®)</h1>
        <p>è¯·ä¸Šä¼ æ‚¨çš„äº¤æ˜“ CSV æ–‡ä»¶ã€‚æ–‡ä»¶ä»pcç«¯:èµ„äº§æ€»è§ˆ-äº¤æ˜“-æˆäº¤è®°å½•-å¯¼å‡º</p>

        <div class="controls">
            <div>
                <input type="file" id="csvFileInput" accept=".csv">
            </div>

            <div>
                <label for="rebatePercentage">è¿”ç‚¹æ¯”ä¾‹:</label>
                <input type="number" id="rebatePercentage" value="35" min="0" max="100">
                <span>%</span>
            </div>

            <button onclick="handleFile()">å¼€å§‹åˆ†æ</button>

            <button class="secondary" onclick="window.open('https://x.com/allen4187/status/1984153221032767917', '_blank', 'noopener,noreferrer')">
                ğ•
            </button>
        </div>

        <div id="status">è¯·é€‰æ‹©æ–‡ä»¶å¹¶ç‚¹å‡»â€œå¼€å§‹åˆ†æâ€ã€‚</div>

        <div id="resultsTable"></div>
    </div>

    <script>
        /**
         * å¯åŠ¨æ–‡ä»¶å¤„ç†
         */
        function handleFile() {
            const fileInput = document.getElementById('csvFileInput');
            const rebateInput = document.getElementById('rebatePercentage');
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('resultsTable');

            if (fileInput.files.length === 0) {
                statusDiv.textContent = "é”™è¯¯ï¼šè¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ã€‚";
                statusDiv.style.color = 'red';
                return;
            }

            let rebatePercentage = parseFloat(rebateInput.value);
            if (isNaN(rebatePercentage) || rebatePercentage < 0 || rebatePercentage > 100) {
                statusDiv.textContent = "é”™è¯¯ï¼šè¿”ç‚¹æ¯”ä¾‹è¯·è¾“å…¥ 0 åˆ° 100 ä¹‹é—´çš„æ•°å­—ã€‚";
                statusDiv.style.color = 'red';
                return;
            }

            const rebateDecimal = rebatePercentage / 100.0;

            const file = fileInput.files[0];
            statusDiv.textContent = `æ­£åœ¨å¤„ç†æ–‡ä»¶: ${file.name}...`;
            statusDiv.style.color = 'blue';
            resultsDiv.innerHTML = "";

            const reader = new FileReader();

            reader.onload = function(event) {
                try {
                    const csvData = event.target.result;
                    const results = processCSV(csvData, rebateDecimal);
                    displayResults(results);
                    statusDiv.textContent = "åˆ†æå®Œæˆï¼";
                    statusDiv.style.color = 'green';
                } catch (error) {
                    statusDiv.textContent = `å¤„ç†å¤±è´¥: ${error.message}`;
                    statusDiv.style.color = 'red';
                    console.error(error);
                }
            };

            reader.onerror = function() {
                statusDiv.textContent = "é”™è¯¯ï¼šæ— æ³•è¯»å–æ–‡ä»¶ã€‚";
                statusDiv.style.color = 'red';
            };

            reader.readAsText(file);
        }

        /**
         * æ ¸å¿ƒå¤„ç†é€»è¾‘
         */
        function processCSV(csvData, rebateDecimal) {
            const lines = csvData.split(/\r?\n/);

            if (lines.length < 2) {
                throw new Error("æ–‡ä»¶ä¸ºç©ºæˆ–æ²¡æœ‰æ•°æ®è¡Œã€‚");
            }

            const header = lines[0].split(',');
            const colIndices = {
                timestamp: header.indexOf('timestamp'),
                fee: header.indexOf('fee'),
                price: header.indexOf('price'),
                quantity: header.indexOf('quantity')
            };

            for (const col of ['timestamp', 'fee', 'price', 'quantity']) {
                if (colIndices[col] === -1) {
                    throw new Error(`CSVæ–‡ä»¶ä¸­ç¼ºå°‘å¿…éœ€çš„åˆ—: '${col}'`);
                }
            }

            // å¼€å§‹æ—¥æœŸ: 2025-09-12
            const startDate = new Date(Date.UTC(2025, 8, 12)); // 8 = 9æœˆ
            const msPerDay = 1000 * 60 * 60 * 24;

            const weeklyStats = new Map();

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;

                const row = line.split(',');
                if (row.length < header.length) continue;

                const timestampStr = row[colIndices.timestamp];
                if (!timestampStr || timestampStr.length < 10) continue;
                const dateStr = timestampStr.substring(0, 10);

                const parts = dateStr.split('-');
                if (parts.length < 3) continue;

                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1;
                const day = parseInt(parts[2], 10);

                const dateOnly = new Date(Date.UTC(year, month, day));

                if (dateOnly < startDate) {
                    continue;
                }

                const timeDiff = dateOnly.getTime() - startDate.getTime();
                const daysDiff = Math.floor(timeDiff / msPerDay);
                const weekNumber = Math.floor(daysDiff / 7) + 1;

                const weekStartDate = new Date(startDate.getTime());
                weekStartDate.setUTCDate(weekStartDate.getUTCDate() + (weekNumber - 1) * 7);
                const weekEndDate = new Date(weekStartDate.getTime());
                weekEndDate.setUTCDate(weekEndDate.getUTCDate() + 6);

                const periodStr = `ç¬¬ ${weekNumber} å‘¨ ${formatDate(weekStartDate)} - ${formatDate(weekEndDate, true)}`;

                const fee = parseFloat(row[colIndices.fee]);
                const price = parseFloat(row[colIndices.price]);
                const quantity = parseFloat(row[colIndices.quantity]);

                if (isNaN(fee) || isNaN(price) || isNaN(quantity)) {
                    continue;
                }
                const tradeVolume = price * quantity;

                if (!weeklyStats.has(periodStr)) {
                    weeklyStats.set(periodStr, {
                        total_fee: 0,
                        total_volume: 0,
                        week_number: weekNumber
                    });
                }
                const stats = weeklyStats.get(periodStr);
                stats.total_fee += fee;
                stats.total_volume += tradeVolume;
            }

            // è®¡ç®—è¿”ç‚¹
            for (const [periodStr, stats] of weeklyStats.entries()) {
                stats.rebate_amount = stats.total_fee * rebateDecimal;
            }

            // æ’åº
            const sortedResults = Array.from(weeklyStats.entries());
            sortedResults.sort((a, b) => a[1].week_number - b[1].week_number);

            return sortedResults;
        }

        /**
         * æ˜¾ç¤ºç»“æœ
         */
        function displayResults(sortedResults) {
            const resultsDiv = document.getElementById('resultsTable');
            if (sortedResults.length === 0) {
                resultsDiv.innerHTML = "<p>åœ¨æŒ‡å®šæ—¥æœŸèŒƒå›´å†…æ²¡æœ‰æ‰¾åˆ°å¯ç»Ÿè®¡çš„æ•°æ®ã€‚</p>";
                return;
            }

            let tableHTML = '<table>';
            tableHTML += '<thead><tr><th>Week Period</th><th>Total Fee</th><th>Total Volume</th><th>è¿”ç‚¹é‡‘é¢ (Rebate)</th></tr></thead>';
            tableHTML += '<tbody>';

            for (const [period, stats] of sortedResults) {
                tableHTML += `
                    <tr>
                        <td>${period}</td>
                        <td>${stats.total_fee.toFixed(8)}</td>
                        <td>${stats.total_volume.toFixed(8)}</td>
                        <td>${stats.rebate_amount.toFixed(8)}</td>
                    </tr>
                `;
            }

            tableHTML += '</tbody></table>';
            resultsDiv.innerHTML = tableHTML;
        }

        /**
         * è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸ
         */
        function formatDate(date, includeYear = false) {
            const options = {
                month: 'long',
                day: 'numeric',
                timeZone: 'UTC'
            };
            if (includeYear) {
                options.year = 'numeric';
            }
            return date.toLocaleDateString('en-US', options);
        }

    </script>

</body>
</html>
