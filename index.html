<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>CSV 交易周报分析器 (v2)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        h1 {
            color: #1a1a1a;
        }
        #container {
            max-width: 1000px; /* 稍微加宽以容纳新列 */
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .controls {
            display: flex;
            align-items: center;
            gap: 15px; /* 控件之间的间距 */
            flex-wrap: wrap; /* 换行 */
        }
        input[type="file"] {
            margin-bottom: 0;
        }
        input[type="number"] {
            width: 60px;
            padding: 5px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        label {
            font-weight: bold;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #status {
            margin-top: 15px;
            font-size: 1.1em;
            color: #555;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            color: #333;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        /* 右对齐数字列 */
        td:nth-child(2), td:nth-child(3), td:nth-child(4) {
            text-align: right;
            font-family: "Courier New", Courier, monospace;
        }
    </style>
</head>
<body>

    <div id="container">
        <h1>backpack 交易周报分析 (纯前端，不会上传数据)</h1>
        <p>请上传您的交易 CSV 文件。周期从 2025-09-12 开始计算。文件从pc端:资产总览-交易-成交记录-导出</p>

        <div class="controls">
            <div>
                <input type="file" id="csvFileInput" accept=".csv">
            </div>

            <div>
                <label for="rebatePercentage">返点比例:</label>
                <input type="number" id="rebatePercentage" value="35" min="0" max="100">
                <span>%</span>
            </div>

            <button onclick="handleFile()">开始分析</button>
        </div>

        <div id="status">请选择文件并点击“开始分析”。</div>

        <div id="resultsTable"></div>
    </div>

    <script>
        /**
         * 启动文件处理
         */
        function handleFile() {
            const fileInput = document.getElementById('csvFileInput');
            const rebateInput = document.getElementById('rebatePercentage'); // 获取新输入框
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('resultsTable');

            if (fileInput.files.length === 0) {
                statusDiv.textContent = "错误：请先选择一个文件。";
                statusDiv.style.color = 'red';
                return;
            }

            // 验证返点比例
            let rebatePercentage = parseFloat(rebateInput.value);
            if (isNaN(rebatePercentage) || rebatePercentage < 0 || rebatePercentage > 100) {
                statusDiv.textContent = "错误：返点比例请输入 0 到 100 之间的数字。";
                statusDiv.style.color = 'red';
                return;
            }

            // 将百分比转换为小数 (例如 35% -> 0.35)
            const rebateDecimal = rebatePercentage / 100.0;

            const file = fileInput.files[0];
            statusDiv.textContent = `正在处理文件: ${file.name}...`;
            statusDiv.style.color = 'blue';
            resultsDiv.innerHTML = ""; // 清空旧结果

            const reader = new FileReader();

            // 文件读取完成后的回调
            reader.onload = function(event) {
                try {
                    const csvData = event.target.result;
                    // 将返点比例传递给处理函数
                    const results = processCSV(csvData, rebateDecimal);
                    displayResults(results); // 传递给显示函数
                    statusDiv.textContent = "分析完成！";
                    statusDiv.style.color = 'green';
                } catch (error) {
                    statusDiv.textContent = `处理失败: ${error.message}`;
                    statusDiv.style.color = 'red';
                    console.error(error);
                }
            };

            // 文件读取失败的回调
            reader.onerror = function() {
                statusDiv.textContent = "错误：无法读取文件。";
                statusDiv.style.color = 'red';
            };

            // 以文本形式读取文件
            reader.readAsText(file);
        }

        /**
         * 核心处理逻辑，解析CSV并统计
         * @param {string} csvData - CSV文件的文本内容
         * @param {number} rebateDecimal - 返点比例 (例如 0.35)
         */
        function processCSV(csvData, rebateDecimal) {
            const lines = csvData.split(/\r?\n/); // 按行分割

            if (lines.length < 2) {
                throw new Error("文件为空或没有数据行。");
            }

            // 1. 解析表头
            const header = lines[0].split(',');
            const colIndices = {
                timestamp: header.indexOf('timestamp'),
                fee: header.indexOf('fee'),
                price: header.indexOf('price'),
                quantity: header.indexOf('quantity')
            };

            // 检查必需的列
            for (const col of ['timestamp', 'fee', 'price', 'quantity']) {
                if (colIndices[col] === -1) {
                    throw new Error(`CSV文件中缺少必需的列: '${col}'`);
                }
            }

            // 2. 定义周期
            // 优化 1: 开始日期从 2025-09-12 开始
            // (0 = 1月, 8 = 9月)
            const startDate = new Date(Date.UTC(2025, 8, 12)); // 2025-09-12
            const msPerDay = 1000 * 60 * 60 * 24;

            // 3. 遍历数据行
            const weeklyStats = new Map();

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue; // 跳过空行

                const row = line.split(',');
                if (row.length < header.length) continue;

                // 4. 按要求处理日期
                const timestampStr = row[colIndices.timestamp];
                if (!timestampStr || timestampStr.length < 10) continue; // 跳过无效时间戳
                const dateStr = timestampStr.substring(0, 10); // 截取 'YYYY-MM-DD'

                const parts = dateStr.split('-');
                if (parts.length < 3) continue;

                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // JS 月份从0开始
                const day = parseInt(parts[2], 10);

                const dateOnly = new Date(Date.UTC(year, month, day));

                // 5. 过滤并计算周期
                if (dateOnly < startDate) {
                    continue; // 忽略早于起始日期的数据
                }

                const timeDiff = dateOnly.getTime() - startDate.getTime();
                const daysDiff = Math.floor(timeDiff / msPerDay);
                const weekNumber = Math.floor(daysDiff / 7) + 1;

                // 6. 创建周期标签
                const weekStartDate = new Date(startDate.getTime());
                weekStartDate.setUTCDate(weekStartDate.getUTCDate() + (weekNumber - 1) * 7);
                const weekEndDate = new Date(weekStartDate.getTime());
                weekEndDate.setUTCDate(weekEndDate.getUTCDate() + 6);

                const periodStr = `第 ${weekNumber} 周 ${formatDate(weekStartDate)} - ${formatDate(weekEndDate, true)}`;

                // 7. 解析数值并计算
                const fee = parseFloat(row[colIndices.fee]);
                const price = parseFloat(row[colIndices.price]);
                const quantity = parseFloat(row[colIndices.quantity]);

                if (isNaN(fee) || isNaN(price) || isNaN(quantity)) {
                    continue; // 跳过无效数值
                }
                const tradeVolume = price * quantity;

                // 8. 累加统计
                if (!weeklyStats.has(periodStr)) {
                    weeklyStats.set(periodStr, {
                        total_fee: 0,
                        total_volume: 0,
                        week_number: weekNumber // 用于排序
                    });
                }
                const stats = weeklyStats.get(periodStr);
                stats.total_fee += fee;
                stats.total_volume += tradeVolume;
            }

            // 9. 计算返点金额 (优化 3)
            // 在排序前，遍历 Map 并计算新列
            for (const [periodStr, stats] of weeklyStats.entries()) {
                stats.rebate_amount = stats.total_fee * rebateDecimal;
            }

            // 10. 排序
            const sortedResults = Array.from(weeklyStats.entries());
            sortedResults.sort((a, b) => a[1].week_number - b[1].week_number);

            return sortedResults;
        }

        /**
         * 将结果显示为 HTML 表格
         * @param {Array} sortedResults - 排序后的统计结果
         */
        function displayResults(sortedResults) {
            const resultsDiv = document.getElementById('resultsTable');
            if (sortedResults.length === 0) {
                resultsDiv.innerHTML = "<p>在指定日期范围内没有找到可统计的数据。</p>";
                return;
            }

            let tableHTML = '<table>';
            // 优化 3: 新增表头
            tableHTML += '<thead><tr><th>Week Period</th><th>Total Fee</th><th>Total Volume</th><th>返点金额 (Rebate)</th></tr></thead>';
            tableHTML += '<tbody>';

            for (const [period, stats] of sortedResults) {
                // 优化 3: 新增数据列
                tableHTML += `
                    <tr>
                        <td>${period}</td>
                        <td>${stats.total_fee.toFixed(8)}</td>
                        <td>${stats.total_volume.toFixed(8)}</td>
                        <td>${stats.rebate_amount.toFixed(8)}</td>
                    </tr>
                `;
            }

            tableHTML += '</tbody></table>';
            resultsDiv.innerHTML = tableHTML;
        }

        /**
         * 辅助函数：格式化日期
         */
        function formatDate(date, includeYear = false) {
            const options = {
                month: 'long',
                day: 'numeric',
                timeZone: 'UTC'
            };
            if (includeYear) {
                options.year = 'numeric';
            }
            return date.toLocaleDateString('en-US', options);
        }

    </script>

</body>
</html>
